<html>

<head>
    <meta charset="UTF-8">
    <title>Diatonic Chord Training</title>
    <link rel="icon" href="img/dct_favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"> 
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <style>
        @import url("dct_style.css");
    </style>
</head>

<body>
    <div id="bg">
        <div id="panel_left">
            <div id=circle_of_fifths>
                <ul class="circle" id="maj_circle">
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>C</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>G</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>D</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>A</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>E</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>B</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>G♭/F♯</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>D♭/C♯</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>A♭</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>E♭</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>B♭</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>F</p>
                            </div>
                        </a></li>
                </ul>
                <ul class="circle" id="min_circle">
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>a</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>e</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>b</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>f♯</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>c♯</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>g♯</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>eb/d♯</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>b♭/a♯</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>f</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>c</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>g</p>
                            </div>
                        </a></li>
                    <li><a class="fifth" draggable="false" href="javascript:;">
                            <div class="text">
                                <p>d</p>
                            </div>
                        </a></li>
                </ul>
                <div class="circle" id="center">
                    <a draggable="false" id="play-stop" href="javascript:;">
                        <div id="play-button">
                            <div class="arrow"></div>
                            <div class="stop"></div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
        <div id="panel_right">
            <p></p>
            <p></p>
            <div class="menu">
                <label class="container">
                    <p>Scale anarchy</p>
                    <input type="checkbox" id="multiple_checkbox">
                    <span class="checkmark"></span>
                </label>
                <label class="container">
                    <p>Show chord name</p>
                    <input type="checkbox" id="chord_checkbox" checked="checked">
                    <span class="checkmark"></span>
                </label>
                <label class="container">
                    <p>Show degree</p>
                    <input type="checkbox" id="degree_checkbox" checked="checked">
                    <span class="checkmark"></span>
                </label>
                <label class="container">
                    <p>Show notes</p>
                    <input type="checkbox" id="notes_checkbox" checked="checked">
                    <span class="checkmark"></span>
                </label>
                <label class="container">
                    <p>Show keyboard</p>
                    <input type="checkbox" id="piano_checkbox" checked="checked">
                    <span class="checkmark"></span>
                </label>
            </div>
            <div class="menu">
                <label class="container">
                    <p>Metronome</p>
                    <input type="checkbox" id="metronome_checkbox" checked="checked">
                    <span class="checkmark"></span>
                </label>
                <div class="slidecontainer">
                    <input type="range" min="20" max="140" value="40" class="slider" id="tempo_slider">
                    <p id="tempo_view">Tempo (40 BPM)</p>
                </div>
                <p></p>
            </div>
        </div>
        <div id="cue-box">
            <p id="chord-name" class="cue">Cmaj</p>
            <p id="notes-list" class="cue">C, E, G</p>
            <p id="degree" class="cue">I</p>
        </div>
        <div id="keyboard"><img src="img/piano/blank.svg"></div>
        <div id="clock">
            <div class="tick"></div>
            <div class="tick"></div>
            <div class="tick"></div>
            <div class="tick"></div>
        </div>
    </div>
    <div id="cp"><a href="http://sstucker.com"><p>STEPHEN TUCKER © 2020</p></a></div>
    <audio id="metronome">
        <source src="audio/Metronome.wav" type="audio/mpeg">
    </audio>
    <audio id="metronome_up">
        <source src="audio/MetronomeUp.wav" type="audio/mpeg">
    </audio>
    <script>

        var major_colors = [
            "rgb(255,0,0)",
            "rgb(255,176,20)",
            "rgb(239, 230, 0)",
            "rgb(0,211,0)",
            "rgb(72,0,255)",
            "rgb(184,0,229)",
            "rgb(255,0,203)"];

        var major_degrees = ["I", "ii", "iii", "IV", "V", "vi", "vii°"];
        var minor_degrees = ["III", "iv", "v", "VI", "VII", "i", "ii°"];

        var active_keys = [12];
        var active_key = 12;

        var chordsLUT = [
            ["Cmaj", "Dmin", "Emin", "Fmaj", "Gmaj", "Amin", "Bdim°"],  // C
            ["Gmaj", "Amin", "Bmin", "Cmaj", "Dmaj", "Emin", "F♯dim°"],  // G
            ["Dmaj", "Emin", "F♯min", "Gmaj", "Amaj", "Bmin", "C♯dim°"],  // D
            ["Amaj", "Bmin", "C♯min", "Dmaj", "Emaj", "F♯min", "G♯dim°"],  // A
            ["Emaj", "F♯min", "G♯min", "Amaj", "Bmaj", "C♯min", "D♯dim°"],  // E
            ["Bmaj", "C♯min", "D♯min", "Emaj", "F♯maj", "G♯min", "A♯dim°"],  // B
            ["F♯maj", "G♯min", "A♯min", "Bmaj", "C♯maj", "D♯min", "E♯dim°"],  // G♭
            ["D♭maj", "E♭min", "Fmin", "G♭maj", "A♭maj", "B♭min", "Cdim°"],  // D♭
            ["A♭maj", "B♭min", "Cmin", "D♭maj", "E♭maj", "Fmin", "Gdim°"],  // A♭
            ["E♭maj", "Fmin", "Gmin", "A♭maj", "B♭maj", "Cmin", "Ddim°"],  // E♭
            ["B♭maj", "Cmin", "Dmin", "E♭maj", "Fmaj", "Gmin", "Adim°"],  // B♭
            ["Fmaj", "Gmin", "Amin", "B♭maj", "Cmaj", "Dmin", "Edim°"],  // F
        ];

        var notesLUT = {
            "Cmaj": "C E G",
            "C♯maj": "C♯ E♯ G♯",
            "Dmaj": "D F♯ A",
            "E♭maj": "E♭ G B♭",
            "Emaj": "E G♯ B",
            "Fmaj": "F A C",
            "F♯maj": "F♯ A♯ C♯",
            "Gmaj": "G B D",
            "A♭maj": "A♭ C E♭",
            "Amaj": "A C♯ E",
            "B♭maj": "B♭ D F",
            "Bmaj": "B D♯ F♯",
            "Cmin": "C E♭ G",
            "C♯min": "C♯ E G♯",
            "Dmin": "D F A",
            "E♭min": "E♭ G♭ B♭",
            "Emin": "E G B",
            "Fmin": "F A♭ C",
            "F♯min": "F♯ A C♯",
            "Gmin": "G B♭ D",
            "A♭min": "A♭ B E♭",
            "Amin": "A C E",
            "B♭min": "B♭ D♭ F",
            "Bmin": "B D F♯",
            "Cdim°": "C E♭ G♭",
            "C♯dim°": "C♯ E G",
            "Ddim°": "D F A♭",
            "E♭dim°": "E♭ G♭ A",
            "Edim°": "E G B♭",
            "Fdim°": "F A♭ B",
            "F♯dim°": "F♯ A C",
            "Gdim°": "G B♭ D♭",
            "A♭dim°": "A♭ B D",
            "Adim°": "A C E♭",
            "B♭dim°": "B♭ D♭ E",
            "Bdim°": "B D F",
        }

        var keyboardfileLUT = {
            "Cmaj": "img/piano/Cmaj.svg",
            "C♯maj": "img/piano/Csmaj.svg",
            "Dmaj": "img/piano/Dmaj.svg",
            "E♭maj": "img/piano/Ebmaj.svg",
            "Emaj": "img/piano/Emaj.svg",
            "Fmaj": "img/piano/Fmaj.svg",
            "F♯maj": "img/piano/Fsmaj.svg",
            "Gmaj": "img/piano/Gmaj.svg",
            "A♭maj": "img/piano/Abmaj.svg",
            "Amaj": "img/piano/Amaj.svg",
            "B♭maj": "img/piano/Bbmaj.svg",
            "Bmaj": "img/piano/Bmaj.svg",
            "Cmin": "img/piano/Cmin.svg",
            "C♯min": "img/piano/Csmin.svg",
            "Dmin": "img/piano/Dmin.svg",
            "E♭min": "img/piano/Ebmin.svg",
            "Emin": "img/piano/Emin.svg",
            "Fmin": "img/piano/Fmin.svg",
            "F♯min": "img/piano/Fsmin.svg",
            "Gmin": "img/piano/Gmin.svg",
            "A♭min": "img/piano/Abmin.svg",
            "Amin": "img/piano/Amin.svg",
            "B♭min": "img/piano/Bbmin.svg",
            "Bmin": "img/piano/Bmin.svg",
            "Cdim°": "img/piano/Cdim.svg",
            "C♯dim°": "img/piano/Csdim.svg",
            "Ddim°": "img/piano/Ddim.svg",
            "E♭dim°": "img/piano/Ebdim.svg",
            "Edim°": "img/piano/Edim.svg",
            "Fdim°": "img/piano/Fdim.svg",
            "F♯dim°": "img/piano/Fsdim.svg",
            "Gdim°": "img/piano/Gdim.svg",
            "A♭dim°": "img/piano/Abdim.svg",
            "Adim°": "img/piano/Adim.svg",
            "B♭dim°": "img/piano/Bbdim.svg",
            "Bdim°": "img/piano/Bdim.svg",
        }

        var interval;

        var cue = $(".cue");
        var chord_name_text = $("#chord-name");
        var scale_degree_text = $("#degree")
        var notes_list_text = $("#notes-list");

        var toggle = $("#play-stop");
        var play_icon = $(".arrow");
        var stop_icon = $(".stop");
        var playing = false;

        var tempo_slider = document.getElementById("tempo_slider");
        var output = document.getElementById("tempo_view");
        var beat = 0;
        var period = 1 / (40 * 1 / 60000)

        var clock = $("#clock");

        var metronome_checkbox = $("#metronome_checkbox");
        var met1 = $('audio#metronome_up');
        var met2 = $('audio#metronome');

        var multiple_checkbox = $("#multiple_checkbox");
        var chord_checkbox = $("#chord_checkbox")
        var degree_checkbox = $("#degree_checkbox");
        var notes_checkbox = $("#notes_checkbox");
        var piano_checkbox = $("#piano_checkbox");

        var keyboard = $("#keyboard img");
        var current_keyboard_img = "img/piano/blank.svg";

        var maj_circle = $("#maj_circle");
        var min_circle = $("#min_circle");
        var circle_of_fifths = $("#circle_of_fifths");

        var last_key = -1;
        var last_deg = -1;

        // Get period from tempo slider
        tempo_slider.oninput = function () {
            output.innerHTML = "Tempo (" + this.value + " BPM)";
            period = 1 / (tempo_slider.value * 1 / 60000)
        }

        var apply_color_to_slice = function (i, selected) {
            if (i < 12) {  // Minor
                if (selected) {
                    min_circle.children().eq(i).find(".text").css("background-color", "#1F2041");
                }
                else {
                    min_circle.children().eq(i).find(".text").css("background-color", "#A095BC");
                }
            }
            else {  // Major
                if (selected) {
                    maj_circle.children().eq(i % 12).find(".text").css("background-color", "#820F19");
                }
                else {
                    maj_circle.children().eq(i % 12).find(".text").css("background-color", "#CC3144");
                }
            }
        }

        var clear_circles = function () {
            for (i = 0; i < 12; i++) {
                min_circle.children().eq(i).find(".text").css("background-color", "#A095BC");
            }
            for (i = 11; i < 24; i++) {
                maj_circle.children().eq(i % 12).find(".text").css("background-color", "#CC3144");
            }
        }

        var update_keys = function (key, scale) {
            if (active_keys.includes(key * 12 + scale)) {  // Deselect
                active_keys = jQuery.grep(active_keys, function (value) {  // Remove clicked fron list
                    return value != key * 12 + scale;
                });
                apply_color_to_slice(key * 12 + scale, false);
            }
            else {  // Select new
                if (multiple_checkbox.is(":checked")) {
                    active_keys.push(key * 12 + scale);
                    apply_color_to_slice(key * 12 + scale, true);
                }
                else {
                    active_keys = [key * 12 + scale];
                    clear_circles();
                    apply_color_to_slice(key * 12 + scale, true);
                }
            }
        }

        var display_chord = function () {
            if (active_keys.length > 0) {
                cue.css("opacity", "0");
                var rand_key = active_keys[Math.floor(Math.random() * active_keys.length)];
                var rand_deg = Math.floor(Math.random() * 7);
                if ((rand_key == last_key) && (rand_deg == last_deg))
                {
                    rand_deg = (rand_deg + 2) % 7;
                }
                last_deg = rand_deg;
                last_key = rand_key;
                if (chord_checkbox.is(":checked")) {
                    var rand_chord = chordsLUT[rand_key % 12][rand_deg];
                    chord_name_text.text(rand_chord);
                }
                else {
                    chord_name_text.text("");
                }
                if (degree_checkbox.is(":checked")) {
                    if (rand_key > 11) {  // Major
                        scale_degree_text.text(major_degrees[rand_deg]);
                        scale_degree_text.css("color", major_colors[rand_deg])
                    }
                    else {  // Minor
                        scale_degree_text.text(minor_degrees[rand_deg]);
                        scale_degree_text.css("color", major_colors[(rand_deg + 2) % 7]);
                    }
                }
                else {
                    scale_degree_text.text("");
                }
                if (notes_checkbox.is(":checked")) {
                    notes_list_text.text(notesLUT[chordsLUT[rand_key % 12][rand_deg]]);
                }
                else {
                    notes_list_text.text("");
                }
                current_keyboard_img = keyboardfileLUT[chordsLUT[rand_key % 12][rand_deg]];
                if (piano_checkbox.is(":checked")) {
                    keyboard.attr("src", current_keyboard_img);
                }
                else {
                    keyboard.attr("src", ""); // Don't load until necessary
                }

                cue.css("opacity", "1");
            }
            else {
                cue.innerHTML = "";
            }
        }

        var advance = function (quiet) {
            if (playing) {
                if (beat == 0) {
                    clock.children().eq(3).css("background-color", "rgb(238,238,238)");
                    if (!quiet) {
                        met1[0].play();
                    }
                    display_chord();
                }
                else {
                    clock.children().eq(beat - 1).css("background-color", "rgb(238,238,238)");
                    if (!quiet) {
                        met2[0].play();
                    }
                    if (beat == 3) {
                        beat = -1;
                    }
                }
                clock.children().eq(beat).css("background-color", "#1F2041");
                beat += 1;
                setTimeout(function () { // Recursively call advance function with period from slider
                    if (metronome_checkbox.is(":checked")) {
                        advance(false);
                    }
                    else {
                        advance(true);
                    }
                }, period);
            }
        }

        var checksize = function() {
            if ($("#panel_right").css("text-align") == "center") {
                $("#panel_right").appendTo("#bg");
                $("#panel_right").css("display","none");
                $("#panel_right").css("display","block");
                var translate_x = (document.documentElement.clientWidth - maj_circle.width()) / 2;
                circle_of_fifths.css("margin-left",translate_x+"px");
            }
            else {
                $("#panel_right").insertAfter($("#panel_left"));
                $("#panel_right").css("display","none");
                $("#panel_right").css("display","block");
                circle_of_fifths.css("margin-left","0");
            }
        }

        $(document).ready(function () {

            // Resize listener
            $(window).resize(checksize);
            checksize(); // Make call to it before display

            // Checkbox listeners
            multiple_checkbox.change(function () {
                if ((!this.checked) && (active_keys.length > 0)) {
                    active_keys = [active_keys[active_keys.length - 1]]; // Truncate to last selected key
                }
            });
            piano_checkbox.change(function () {
                if (!this.checked) {
                    keyboard.parent().css("display","none");
                }
                if (this.checked) {
                    keyboard.parent().css("display","table-cell");
                    keyboard.attr("src",current_keyboard_img)
                }
            });
            chord_checkbox.change(function () {
                if (!this.checked) {
                    chord_name_text.css("display","none");
                }
                if (this.checked) {
                    chord_name_text.css("display","");
                }
            });
            degree_checkbox.change(function () {
                if (!this.checked) {
                    scale_degree_text.css("display","none");
                }
                if (this.checked) {
                    scale_degree_text.css("display","");
                }
            });
            notes_checkbox.change(function () {
                if (!this.checked) {
                    notes_list_text.css("display","none");
                }
                if (this.checked) {
                    notes_list_text.css("display","");
                }
            });
            $('#min_circle li').click(function () {
                update_keys(0, $(this).index());
            });
            $('#maj_circle li').click(function () {
                update_keys(1, $(this).index());
            });
            toggle.click(function () {
                if (playing == true) {  // Stop
                    playing = false;
                    play_icon.css("display", "inline-block");
                    stop_icon.css("display", "none");
                    for (i = 0; i < 4; i++) {
                        clock.children().eq(i).css("background-color", "rgb(238,238,238)");
                    }
                    beat = 0;
                    cue.css("opacity", "0");
                }
                else {  // Start
                    playing = true;
                    play_icon.css("display", "none");
                    stop_icon.css("display", "inline-block");
                    if (metronome_checkbox.is(":checked")) {
                        advance(false);
                    }
                    else {
                        advance(true);
                    }
                }
            });
        });
    </script>
</body>

</html>