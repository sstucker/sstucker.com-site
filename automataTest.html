<!doctype html>
<html>
<head>
<meta charset="utf-8">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.3.6/svg.min.js"></script>

<title>automataBackgroundSVG</title>
</head>
<style>
#bg {
	position: fixed;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	background-repeat: no-repeat;
	background-attachment: fixed;
	-webkit-background-size: cover;
	-moz-background-size: cover;
	-o-background-size: cover;
	background-size: cover !important;
}
#automataSVG {
	height: 100%;
	width: 100%;
	overflow: hidden;
}
</style>
<body>
<div id="bg"><div id="automataSVG"></div></div>
<script>
var screenWidth = parseInt($("#bg").css("width"));
var screenHeight = parseInt($("#bg").css("height"));
console.log(screenWidth,screenHeight);
const cellSize = 50;
var boardWidth = Math.round(screenWidth/cellSize);
var boardHeight = Math.round(screenHeight/cellSize);
console.log(boardWidth,boardHeight);
const birthValue = 3;
const deathThreshLow = 2;
const deathThreshHigh = 3;
const refreshRate = 50;
var automataLUT = ["#FFFFFF","#000000"] //LUT for state colors
function mod(n, m) {
  //for our toroidal indexing we'll need a modulo function, not just js's remainder (%)
  return ((n % m) + m) % m;
}
function sleep(ms) {
  //thank you to stack overflow user dan dascalescu
  return new Promise(resolve => setTimeout(resolve, ms));
}
function initBoard() {
	window.automataBoard = [];
  	for (var i=0;i<boardWidth;i++) {
    	automataBoard[i]=new Array(boardHeight);
  	};
	window.automataSVG = SVG("automataSVG").size(boardWidth*cellSize,boardHeight*cellSize);
	for (var i=0;i<boardWidth;i++) {
		for (var j=0;j<boardHeight;j++) {
			var cell = {
				indexx : i,
				indexy : j,
				posx : i*cellSize,
				posy : j*cellSize,
				Z : 0,
				S : 0,
				SVGdraw : function(){
					automataSVG.rect(cellSize,cellSize).move(this.posx,this.posy).animate(2*refreshRate,'<>',3*refreshRate).fill(automataLUT[this.Z]).stroke("none");
				},
			}
			automataBoard[i][j] = cell;
			automataBoard[i][j].SVGdraw();
		}
	}
}
function updateBoard(board) {
  //conway's game of life indexing and algo calculates new board. called on board
  getMouseCell(board);
  for (var i=0;i<boardWidth;i++) {
    for (var j=0;j<boardHeight;j++) {
	  var currentCell = board[i][j];
      var Z = currentCell.Z;
      var S = 0;
      //toroidal indexing
      S += board[mod((i+1),boardWidth)][mod((j+1),boardHeight)].Z;
      S += board[mod((i+1),boardWidth)][mod(j,boardHeight)].Z;
      S += board[mod((i+1),boardWidth)][mod((j-1),boardHeight)].Z;
      S += board[mod(i,boardWidth)][mod((j+1),boardHeight)].Z;
      S += board[mod(i,boardWidth)][mod((j-1),boardHeight)].Z;
      S += board[mod((i-1),boardWidth)][mod((j+1),boardHeight)].Z;
      S += board[mod((i-1),boardWidth)][mod(j,boardHeight)].Z;
      S += board[mod((i-1),boardWidth)][mod((j-1),boardHeight)].Z;
      //implementation of 2-state conway algo. (cell obj supports more states!)
      if (Z == 1) {
        if ((S < deathThreshLow) || (S > deathThreshHigh)) {
		   currentCell.Z = 0;
		   currentCell.SVGdraw();
		};
      };
      if (Z == 0) {
        if (S == birthValue) {
		  currentCell.Z = 1;
		  currentCell.SVGdraw();
        };
      };
    };
  };
  return board;
};
function getMouseCell(board){
	document.addEventListener("mousemove",onMousemove);
	var mouseMoved = false;
	setTimeout(function() {
		if (!mouseMoved){
			try {
				board[mousei][mousej].Z = 1;
				board[mousei][mousej].SVGdraw()
			} catch(err) {
				console.log("No mouse coords yet")};
			document.removeEventListener("mousemove",onMousemove);
			}
		},refreshRate/2,);
	function onMousemove(event){
		mouseMoved = true;
		mousei = Math.round(event.pageX/cellSize)-1;
		mousej = Math.round(event.pageY/cellSize)-1;
		board[mousei][mousej].Z = 1;
		board[mousei][mousej].SVGdraw();
		document.removeEventListener("mousemove",onMousemove);
	}
}
initBoard();
automataBoard[5][5].Z = 1;
automataBoard[6][5].Z = 1;
automataBoard[7][5].Z = 1;
automataBoard[7][5].Z = 1;
automataBoard[7][4].Z = 1;
automataBoard[6][3].Z = 1;

var mousei = undefined;
var mousej = undefined;
function runBoard(){
	automataBoard = updateBoard(automataBoard);
}
console.log("automata widget loaded!")
setInterval(runBoard,refreshRate);
</script>
</body>
</html>
